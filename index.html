<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WHOWHERE V2 – HTML</title>
</head>
<body>

<script>
// ==UserScript==
// @name         WHOWHERE V2 GM - All Languages + Viewer Small Button
// @namespace    http://tampermonkey.net/
// @version      3.0
// @description  WhoWhere V2 GM_xmlhttpRequest for Gartic.io - All Languages + Viewer Small Button
// @author       Rascalov31 
// @match        https://gartic.io/yey
// @icon         https://www.google.com/s2/favicons?sz=64&domain=gartic.io
// @grant        GM_xmlhttpRequest
// ==/UserScript==

(function() {
'use strict';

console.log('Gartic.io WhoWhere GM hazirdir!');

// --- UI ELEMENTLERI ---
const overlay = document.createElement('div');
overlay.className = 'overlay';

const header = document.createElement('header');
header.innerHTML = '<h2>M2H</h2>';
overlay.append(header);

const p = document.createElement('p');
p.textContent = 'Hazırki Otağlar';
overlay.append(p);

const closeButton = document.createElement('button');
closeButton.textContent = '';
closeButton.style.cssText = 'position: fixed; top: 10px; right: 10px; padding: 5px 10px; background-color: darkred; color: white; border: none; border-radius: 5px; cursor: pointer;';
overlay.append(closeButton);

const openButton = document.createElement('button');
openButton.textContent = '';
openButton.style.cssText = 'position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background-color: darkgreen; color: white; border: none; border-radius: 5px; cursor: pointer; display: none; z-index: 9999;';
document.body.append(openButton);

closeButton.onclick = () => {
    overlay.style.display = 'none';
    openButton.style.display = 'block';
};
openButton.onclick = () => {
    overlay.style.display = 'block';
    openButton.style.display = 'none';
};

// --- DILLER (HAMISI) ---
const select = document.createElement('select');
select.id = 'lg';
select.innerHTML = `

<option value="23" selected>Azərbaycanca</option>
<option value="1">Português</option>
<option value="2">English</option>
<option value="3">Español</option>
<option value="4">Français</option>
<option value="5">Italiano</option>
<option value="6">Deutsch</option>
<option value="7">Русский</option>
<option value="8">Türkçe</option>
<option value="9">Polski</option>
<option value="10">Nederlands</option>
<option value="11">Čeština</option>
<option value="12">Magyar</option>
<option value="13">Română</option>
<option value="14">Українська</option>
<option value="15">Svenska</option>
<option value="16">Suomi</option>
<option value="17">Dansk</option>
<option value="18">Norsk</option>
<option value="19">العربية</option>
<option value="20">فارسی</option>
<option value="21">한국어</option>
<option value="22">日本語</option>
<option value="24">हिन्दी</option>
<option value="25">ไทย</option>
<option value="26">Bahasa Indonesia</option>
<option value="27">Tiếng Việt</option>
<option value="28">中文</option>
`;
overlay.append(select);

const flexDiv = document.createElement('div');
flexDiv.className = 'flex';
overlay.append(flexDiv);

const totalCountDisplay = document.createElement('div');
totalCountDisplay.style.cssText = 'position: fixed; top: 50px; left: 10px; background-color: darkslateblue; color: white; padding: 5px 10px; border-radius: 5px; z-index: 9999;';
document.body.append(totalCountDisplay);

document.body.prepend(overlay);

// --- STIL ---
const style = document.createElement('style');
style.textContent = `
    .overlay {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background-color:#000; color:#f0f0f0; z-index:9999; overflow-y:auto;
        text-align:center; padding:20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .overlay h2 {
        color:#ff3c3c;
        text-shadow: 0 0 8px #ff3c3c, 0 0 16px #ff0000;
        margin-bottom: 10px;
    }
    .flex { display:flex; justify-content:center; flex-wrap:wrap; gap:12px; margin-top:1rem; }
    .flex-child {
        background: #111; padding:12px 18px; min-width:180px; border-radius:12px;
        box-shadow: 0 0 12px rgba(255,0,0,0.5);
        display:flex; flex-direction:column; align-items:center; transition: transform 0.2s, box-shadow 0.2s;
    }
    .flex-child:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(255,0,0,0.8); }
    .flex-child img { width:32px; height:32px; border-radius:50%; border:1px solid #666; margin-bottom:6px; }
    .users .user-info { display:flex; align-items:center; margin-bottom:6px; justify-content:flex-start; }
    .users .user-info p { margin-left:6px; font-size:13px; color:#ccc; overflow-wrap:anywhere; }
    select {
        font-size:16px; padding:6px 12px; border-radius:30px;
        background-color:#222; color:white; border:1px solid #444; margin-bottom:10px;
    }
    .viewer-btn {
        display:block; width:80px; margin:6px auto 12px auto;
        padding:4px 0; border-radius:6px; background-color:#222;
        color:#fff; text-decoration:none; font-weight:bold; text-align:center;
        font-size:12px;
        box-shadow:0 0 6px rgba(255,0,0,0.5); transition: all 0.2s;
    }
    .viewer-btn:hover { background-color:#ff0000; box-shadow:0 0 12px rgba(255,0,0,0.8); }
`;
document.head.append(style);

// --- FUNKSIYA ---
function f(lang) {
    GM_xmlhttpRequest({
        method: "GET",
        url: `https://gartic.io/req/list?search=&language[]=${lang}`,
        onload: function(response) {
            const data = JSON.parse(response.responseText);
            const active = data.filter(room => room.quant > 0);

            if (active.length === 0) {
                flexDiv.innerHTML = '<h2>Seçilən dildə otağ yoxdur.</h2>';
                totalCountDisplay.textContent = '';
                return;
            }

            flexDiv.innerHTML = '';

            active.forEach((room) => {
                const flc = document.createElement('div');
                flc.classList.add('flex-child');
                flexDiv.appendChild(flc);

                const roomTag = document.createElement('h3');
                roomTag.innerText = room.id.slice(1);

                const roomSubjIcon = document.createElement('img');
                roomSubjIcon.src = `https://gartic.io/static/images/subjects/${room.subject}.svg`;

                const inRoomPlayers = document.createElement('p');
                inRoomPlayers.innerText = `${room.quant} / ${room.max} ・ ${room.points} / ${room.goal}`;

                const users = document.createElement('div');
                users.classList.add('users');

                flc.append(roomTag, roomSubjIcon, inRoomPlayers, users);

                const viewBtn = document.createElement('a');
                viewBtn.href = `https://gartic.io/${room.code}/viewer`;
                viewBtn.target = '_blank';
                viewBtn.innerText = 'Viewer';
                viewBtn.classList.add('viewer-btn');
                flc.appendChild(viewBtn);

                GM_xmlhttpRequest({
                    method: "GET",
                    url: `https://gartic.io/serverViewer?room=${room.code}`,
                    onload: function(rs) {
                        const dt = rs.responseText;
                        const s = dt.slice(15,16);
                        const ws = new WebSocket(`wss://server0${s}.gartic.io/socket.io/?EIO=3&transport=websocket`);

                        ws.onopen = () => {
                            ws.send(`42["12",{"v":20000,"sala":"${room.id}"}]`);
                        };
                        ws.onmessage = (m) => {
                            try {
                                const d = JSON.parse(m.data.slice(2));
                                if(d[0] == 5) {
                                    users.innerHTML = '';
                                    for(let i=0;i<d[5].length;i++){
                                        const userB = document.createElement('div');
                                        userB.classList.add('user-info');

                                        const userPp = document.createElement('img');
                                        userPp.src = d[5][i].foto || 'https://gartic.io/static/images/avatar/svg/0.svg';

                                        const userName = document.createElement('p');
                                        userName.innerText = d[5][i].nick;

                                        userB.append(userPp, userName);
                                        users.append(userB);
                                    }
                                }
                            } catch(e){ console.error(e); }
                        };
                    }
                });

            });

            totalCountDisplay.innerText =
                `Total Otağ: ${active.length}, Total User: ${active.reduce((a,c)=>a+c.quant,0)}`;
        }
    });
}

select.onchange = function(){ f(this.value); }
f('23'); // default AZ

})();
</script>

</body>
</html>
