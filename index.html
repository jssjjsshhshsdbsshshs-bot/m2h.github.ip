<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gartic.io Otaqlar ‚Äì WhoWhere V2 (Oyun√ßularla)</title>
  <style>
    body { margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:#0a0a0a; color:#f0f0f0; }
    .overlay { position:fixed; inset:0; background:#000; padding:20px; overflow-y:auto; text-align:center; }
    h2 { color:#ff3c3c; text-shadow:0 0 8px #ff3c3c, 0 0 16px #ff0000; margin-bottom:10px; }
    select, .btn { font-size:16px; padding:6px 12px; border-radius:30px; background:#222; color:white; border:1px solid #444; margin:4px; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn:hover { background:#ff3c3c !important; }
    .flex { display:flex; justify-content:center; flex-wrap:wrap; gap:12px; margin-top:1rem; }
    .flex-child { background:#111; padding:12px 18px; min-width:180px; border-radius:12px; box-shadow:0 0 12px rgba(255,0,0,0.5); display:flex; flex-direction:column; align-items:center; transition:all 0.25s; }
    .flex-child:hover { transform:translateY(-5px); box-shadow:0 0 20px rgba(255,0,0,0.8); }
    .flex-child img { width:32px; height:32px; border-radius:50%; border:1px solid #666; margin-bottom:6px; }
    .users { width:100%; margin:8px 0; min-height:60px; max-height:150px; overflow-y:auto; }
    .user-info { display:flex; align-items:center; margin-bottom:6px; font-size:13px; color:#ccc; }
    .user-info img { width:24px; height:24px; margin-right:8px; border-radius:50%; }
    .viewer-btn, .fako-btn { display:block; width:80px; margin:6px auto 0; padding:4px 0; border-radius:6px; background:#222; color:#fff; text-decoration:none; font-weight:bold; font-size:12px; box-shadow:0 0 6px rgba(255,0,0,0.5); transition:all 0.2s; }
    .viewer-btn:hover, .fako-btn:hover { background:#ff0000; box-shadow:0 0 12px rgba(255,0,0,0.8); }
    #total { position:fixed; top:10px; left:10px; background:darkslateblue; color:white; padding:6px 12px; border-radius:6px; z-index:10000; font-size:14px; }
    #status { color:#ffcc00; font-weight:bold; margin:10px; font-size:14px; }
    .error-msg { color:#ff6666; font-size:12px; margin:4px 0; }
    .loading { color:#888; }
  </style>
</head>
<body>

<div class="overlay">
  <h2>M2H ‚Ä¢ Gartic.io Otaqlar (Oyun√ßularla ‚Äì Chrome disable il…ô)</h2>
  <div id="status">Y√ºkl…ônir...</div>
  
  <select id="lg">
    <option value="23" selected>Az…ôrbaycanca</option>
    <!-- Dig…ôr dill…ôr eyni -->
    <option value="1">Portugu√™s</option><option value="2">English</option><option value="3">Espa√±ol</option><option value="4">Fran√ßais</option><option value="5">Italiano</option>
    <option value="6">Deutsch</option><option value="7">–†—É—Å—Å–∫–∏–π</option><option value="8">T√ºrk√ße</option><option value="9">Polski</option><option value="10">Nederlands</option>
    <option value="11">ƒåe≈°tina</option><option value="12">Magyar</option><option value="13">Rom√¢nƒÉ</option><option value="14">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
    <option value="15">Svenska</option><option value="16">Suomi</option><option value="17">Dansk</option><option value="18">Norsk</option>
    <option value="19">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option><option value="20">ŸÅÿßÿ±ÿ≥€å</option><option value="21">ÌïúÍµ≠Ïñ¥</option><option value="22">Êó•Êú¨Ë™û</option>
    <option value="24">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option><option value="25">‡πÑ‡∏ó‡∏¢</option><option value="26">Bahasa Indonesia</option><option value="27">Ti·∫øng Vi·ªát</option><option value="28">‰∏≠Êñá</option>
  </select>
  <br>
  <a href="#" id="fakoBtn" class="btn" style="background:#00ff00;color:black;">üî• FAKO Viewer (Tampermonkey)</a>

  <div class="flex" id="rooms"></div>
</div>

<div id="total">Y√ºkl…ônir...</div>

<script>
const langSelect = document.getElementById('lg');
const roomsContainer = document.getElementById('rooms');
const totalDisplay = document.getElementById('total');
const statusDiv = document.getElementById('status');
const fakoBtn = document.getElementById('fakoBtn');

fakoBtn.href = `https://gartic.io/?fako&lang=${langSelect.value}`;
langSelect.onchange = () => { fakoBtn.href = `https://gartic.io/?fako&lang=${langSelect.value}`; loadRooms(langSelect.value); };

const PROXY = 'https://corsproxy.io/?';
const BACKUP_PROXY = 'https://api.allorigins.win/raw?url=';

async function fetchWithProxy(url, isText = false) {
  try {
    let fullUrl = PROXY + encodeURIComponent(url);
    let res = await fetch(fullUrl);
    if (!res.ok) {
      fullUrl = BACKUP_PROXY + encodeURIComponent(url);
      res = await fetch(fullUrl);
    }
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return isText ? await res.text() : await res.json();
  } catch (err) {
    throw err;
  }
}

async function loadRooms(lang = '23') {
  roomsContainer.innerHTML = '<p class="loading">Otaqlar y√ºkl…ônir...</p>';
  totalDisplay.textContent = 'Y√ºkl…ônir...';
  statusDiv.textContent = 'Proxy il…ô y√ºkl…ônir... (Oyun√ßular √º√ß√ºn Chrome --disable-web-security istifad…ô et)';

  try {
    const listUrl = `https://gartic.io/req/list?search=&language[]=${lang}`;
    const data = await fetchWithProxy(listUrl);

    const active = data.filter(r => r.quant > 0);

    if (active.length === 0) {
      roomsContainer.innerHTML = '<h3>Se√ßil…ôn dild…ô aktiv otaq yoxdur.</h3>';
      return;
    }

    roomsContainer.innerHTML = '';

    for (const room of active) {
      const card = document.createElement('div');
      card.className = 'flex-child';

      card.innerHTML = `
        <h3>${room.id.slice(1)}</h3>
        <img src="https://gartic.io/static/images/subjects/${room.subject}.svg" alt="subject">
        <p>${room.quant} / ${room.max} „Éª ${room.points} / ${room.goal}</p>
        <div class="users" id="users-${room.code}">
          <small class="loading">Oyun√ßular y√ºkl…ônir...</small>
        </div>
        <a href="https://gartic.io/${room.code}/viewer" target="_blank" class="viewer-btn">Viewer</a>
      `;

      roomsContainer.appendChild(card);

      // WebSocket c…ôhdi (Chrome disable il…ô i≈ül…ôy…ôr)
      try {
        const viewerUrl = `https://gartic.io/serverViewer?room=${room.code}`;
        const text = await fetchWithProxy(viewerUrl, true);
        const serverNum = text.slice(15, 16);
        if (!/^\d$/.test(serverNum)) throw new Error('Server tapƒ±lmadƒ±');

        const wsUrl = `wss://server0${serverNum}.gartic.io/socket.io/?EIO=3&transport=websocket`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          ws.send(`42["12",{"v":20000,"sala":"${room.id}"}]`);
          document.getElementById(`users-${room.code}`).innerHTML = '<small>Baƒülantƒ± quruldu...</small>';
        };

        ws.onmessage = (event) => {
          try {
            const raw = event.data;
            if (!raw.startsWith('42')) return;
            const parsed = JSON.parse(raw.slice(2));
            if (parsed[0] !== 5) return;

            const usersDiv = document.getElementById(`users-${room.code}`);
            usersDiv.innerHTML = '';

            (parsed[5] || []).forEach(user => {
              const div = document.createElement('div');
              div.className = 'user-info';
              div.innerHTML = `<img src="\( {user.foto || 'https://gartic.io/static/images/avatar/svg/0.svg'}" alt=""> <span> \){user.nick || 'Anonim'}</span>`;
              usersDiv.appendChild(div);
            });

            if (usersDiv.children.length === 0) usersDiv.innerHTML = '<small class="error-msg">Otaqda he√ß kim yoxdur</small>';
          } catch (e) { console.error('Parse x…ôtasƒ±:', e); }
        };

        ws.onerror = (e) => {
          console.error('WS x…ôtasƒ±:', e); // Konsolda detallarƒ± g√∂r
          document.getElementById(`users-${room.code}`).innerHTML = '<small class="error-msg">WebSocket bloklandƒ± (Chrome disable et!)</small>';
        };

      } catch (e) {
        console.warn('Server x…ôtasƒ±:', e);
        document.getElementById(`users-${room.code}`).innerHTML = '<small class="error-msg">Server m…ôlumatƒ± y√ºkl…ônm…ôdi</small>';
      }
    }

    const totalPlayers = active.reduce((sum, r) => sum + r.quant, 0);
    totalDisplay.textContent = `Otaq: ${active.length} | Oyun√ßu: ${totalPlayers}`;
    statusDiv.textContent = 'Y√ºkl…ôndi ‚úì Oyun√ßular √º√ß√ºn: Chrome --disable-web-security v…ô ya FAKO d√ºym…ôsi';

  } catch (err) {
    statusDiv.textContent = 'X…ôta: ' + err.message;
    roomsContainer.innerHTML = `<h3 style="color:#f55">X…ôta: ${err.message}</h3>`;
  }
}

langSelect.onchange = () => loadRooms(langSelect.value);
loadRooms('23');
</script>
</body>
</html>
