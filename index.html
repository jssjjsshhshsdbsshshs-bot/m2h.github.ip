<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gartic.io Otaqları - Viewer (Bütün Dillər)</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#0d0d0d;
      color:#e0e0e0;
      font-family: system-ui, -apple-system, sans-serif;
      min-height:100vh;
    }
    header {
      padding: 20px;
      text-align:center;
      background: linear-gradient(to bottom, #1a1a1a, #0d0d0d);
      border-bottom:1px solid #333;
    }
    h1 {
      color:#ff4d4d;
      text-shadow:0 0 10px rgba(255,77,77,0.6);
      margin-bottom:10px;
    }
    #controls {
      margin:20px auto;
      max-width:600px;
      text-align:center;
    }
    select {
      padding:12px 24px;
      font-size:17px;
      background:#222;
      color:white;
      border:1px solid #444;
      border-radius:30px;
      cursor:pointer;
      min-width:220px;
    }
    #stats {
      margin:15px 0;
      font-weight:bold;
      color:#aaa;
    }
    #rooms {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:16px;
      padding:20px;
      max-width:1600px;
      margin:0 auto;
    }
    .card {
      background:#1a1a1a;
      border-radius:12px;
      padding:16px;
      width:260px;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
      transition:all 0.25s ease;
      text-align:center;
    }
    .card:hover {
      transform:translateY(-8px);
      box-shadow:0 12px 30px rgba(255,77,77,0.3);
    }
    .card h3 {
      font-size:1.4rem;
      margin-bottom:8px;
      color:#ff9999;
    }
    .card img.subject {
      width:56px;
      height:56px;
      margin:10px 0;
    }
    .info {
      font-size:0.95rem;
      color:#bbb;
      margin:8px 0;
    }
    .users {
      min-height:90px;
      margin:12px 0;
      font-size:0.9rem;
      text-align:left;
    }
    .user {
      display:flex;
      align-items:center;
      margin:6px 0;
    }
    .user img {
      width:28px;
      height:28px;
      border-radius:50%;
      margin-right:10px;
      border:1px solid #444;
    }
    .viewer-btn {
      display:block;
      background:#ff4d4d;
      color:white;
      padding:10px;
      margin-top:12px;
      border-radius:8px;
      text-decoration:none;
      font-weight:bold;
      transition:all 0.2s;
    }
    .viewer-btn:hover {
      background:#e63939;
      transform:scale(1.04);
    }
    .loading, .error {
      text-align:center;
      padding:40px;
      font-size:1.2rem;
      color:#888;
    }
  </style>
</head>
<body>

<header>
  <h1>Gartic.io Otaqları</h1>
  <p style="color:#aaa;">Real vaxtda aktiv otaqlar + oyunçular + viewer</p>
</header>

<div id="controls">
  <select id="lang">
    <option value="23" selected>Azərbaycanca</option>
    <option value="1">Português</option>
    <option value="2">English</option>
    <option value="3">Español</option>
    <option value="4">Français</option>
    <option value="5">Italiano</option>
    <option value="6">Deutsch</option>
    <option value="7">Русский</option>
    <option value="8">Türkçe</option>
    <option value="9">Polski</option>
    <option value="10">Nederlands</option>
    <option value="11">Čeština</option>
    <option value="12">Magyar</option>
    <option value="13">Română</option>
    <option value="14">Українська</option>
    <option value="15">Svenska</option>
    <option value="16">Suomi</option>
    <option value="17">Dansk</option>
    <option value="18">Norsk</option>
    <option value="19">العربية</option>
    <option value="20">فارسی</option>
    <option value="21">한국어</option>
    <option value="22">日本語</option>
    <option value="24">हिन्दी</option>
    <option value="25">ไทย</option>
    <option value="26">Bahasa Indonesia</option>
    <option value="27">Tiếng Việt</option>
    <option value="28">中文</option>
  </select>
  <div id="stats"></div>
</div>

<div id="rooms"></div>

<script>
  const langSelect = document.getElementById('lang');
  const roomsContainer = document.getElementById('rooms');
  const stats = document.getElementById('stats');

  async function loadRooms(lang) {
    roomsContainer.innerHTML = '<div class="loading">Otaqlar yüklənir...</div>';
    stats.textContent = '';

    try {
      const res = await fetch(`https://gartic.io/req/list?search=&language[]=${lang}`);
      if (!res.ok) throw new Error('Server cavabı alınmadı');
      
      const data = await res.json();
      const active = data.filter(r => r.quant > 0);

      roomsContainer.innerHTML = '';

      if (active.length === 0) {
        roomsContainer.innerHTML = '<div class="error">Seçdiyiniz dildə aktiv otaq tapılmadı...</div>';
        return;
      }

      let totalPlayers = 0;

      for (const room of active) {
        totalPlayers += room.quant;

        const card = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <h3>${room.id.slice(1)}</h3>
          <img class="subject" src="https://gartic.io/static/images/subjects/${room.subject}.svg" alt="subject">
          <div class="info">${room.quant} / ${room.max}  •  ${room.points} / ${room.goal}</div>
          <div class="users">Oyunçular yüklənir...</div>
          <a href="https://gartic.io/${room.code}/viewer" target="_blank" class="viewer-btn">Viewer aç</a>
        `;

        roomsContainer.appendChild(card);

        // Real vaxt oyunçular (websocket)
        try {
          const srvRes = await fetch(`https://gartic.io/serverViewer?room=${room.code}`);
          const srvText = await srvRes.text();
          const serverNum = srvText.slice(15, 16);

          if (/^[1-9]$/.test(serverNum)) {
            const ws = new WebSocket(`wss://server0${serverNum}.gartic.io/socket.io/?EIO=3&transport=websocket`);

            ws.onopen = () => {
              ws.send(`42["12",{"v":20000,"sala":"${room.id}"}]`);
            };

            ws.onmessage = (event) => {
              if (!event.data.startsWith('42')) return;
              try {
                const parsed = JSON.parse(event.data.slice(2));
                if (parsed[0] === 5 && parsed[5]) {
                  const usersDiv = card.querySelector('.users');
                  usersDiv.innerHTML = parsed[5].map(user => `
                    <div class="user">
                      <img src="\( {user.foto || 'https://gartic.io/static/images/avatar/svg/0.svg'}" alt=" \){user.nick}">
                      <span>${user.nick}</span>
                    </div>
                  `).join('');
                }
              } catch {}
            };
          } else {
            card.querySelector('.users').textContent = 'Oyunçu məlumatı əldə olunmadı';
          }
        } catch {
          card.querySelector('.users').textContent = 'Oyunçu məlumatı əldə olunmadı';
        }
      }

      stats.textContent = `Aktiv otaq: ${active.length}  •  Ümumi oyunçu: ${totalPlayers}`;

    } catch (err) {
      roomsContainer.innerHTML = `<div class="error">Xəta: ${err.message || 'Bağlantı problemi'}</div>`;
    }
  }

  langSelect.addEventListener('change', () => loadRooms(langSelect.value));
  
  // İlk yükləmə
  loadRooms('23');
</script>
</body>
</html>
